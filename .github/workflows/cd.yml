name: 'Continuous Deployment'

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and Push Docker Image to ACR
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 3: Log in to Azure Container Registry (ACR) using username and password
      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ secrets.ACR_NAME }} \
                        --username ${{ secrets.ACR_USERNAME }} \
                        --password ${{ secrets.ACR_PASSWORD }}

      # Step 4: Build Docker image
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/sca-api:latest .

      # Step 5: Push Docker image to ACR
      - name: Push Docker image to ACR
        run: |
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/sca-api:latest

      # Step 6: Apply Prisma migrations
      - name: Apply Prisma migrations
        # run inside the freshly-pushed image so code + prisma schema match
        run: |
          docker run --rm \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            ${{ secrets.ACR_NAME }}.azurecr.io/sca-api:latest \
            npx prisma migrate deploy
